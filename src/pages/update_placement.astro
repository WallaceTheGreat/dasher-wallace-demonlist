---
export const prerender = false;

import { updatePlacement, archiveCurrentRanking, getCurrentRankings } from '../libs/queries';

let message = '';
let error = '';

if (Astro.request.method === 'POST') {
	try {
		const formData = await Astro.request.formData();
		const levelIdStr = formData.get('level_id')?.toString() || '';
		const newPlacementStr = formData.get('new_placement')?.toString() || '';

		const level_id = parseInt(levelIdStr);
		const new_placement = parseInt(newPlacementStr);

		if (!level_id || !new_placement || new_placement < 1) {
			error = 'Invalid input';
		} else {
			const currentRankings = getCurrentRankings();
			const currentRank = currentRankings.find((r: any) => r.level_id === level_id);

			if (!currentRank) {
				error = 'No level found!!!';
			} else {
				const old_placement = currentRank.place;

				updatePlacement(level_id, old_placement, new_placement);
				archiveCurrentRanking();

				message = `Placement updated from ${old_placement} to ${new_placement}`;
			}
		}
	} catch (e) {
		error = `Error: ${e}`;
	}
}

const currentRankings = getCurrentRankings();
---

<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Update Placement</title>
	</head>
	<body>

	<h1>Update Placement</h1>

	{message && <p class="success">{message}</p>}
	{error && <p class="error">{error}</p>}

	<form method="POST">
		<div>
			<label for="level_id">Select Level</label>
			<select id="level_id" name="level_id" required>
				<option value="">-- Choose a level --</option>
				{currentRankings.map((rank: any) => (
					<option value={rank.level_id}>
						#{rank.place} - {rank.level_name}
					</option>
				))}
			</select>
		</div>

		<div>
			<label for="new_placement">New Position</label>
			<input
				type="number"
				id="new_placement"
				name="new_placement"
				min="1"
				required
			/>
		</div>

		<button>Update Placement</button>
	</form>

	<hr />

	<h2>Current Rankings</h2>
	<ul>
		{currentRankings.map((rank: any) => (
			<li>#{rank.place} - {rank.level_name}</li>
		))}
	</ul>

	<a href="/">Go back</a>

	</body>
</html>
